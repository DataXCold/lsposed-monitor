# .github/workflows/monitor_lsposed.yml

name: Monitor LSPosed Artifacts

on:
  schedule:
    # Runs every 15 minutes to check for new artifacts
    - cron: "*/15 * * * *"
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  check-for-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest successful workflow run in JingMatrix/LSPosed
        id: get_run
        run: |
          # The target repository is already set here
          TARGET_REPO="JingMatrix/LSPosed"

          API_URL="https://api.github.com/repos/${TARGET_REPO}/actions/runs?status=success&per_page=1"
          
          # Make an authenticated API call to GitHub
          LATEST_RUN_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" $API_URL)
          
          # Parse the response to get the latest run's details
          LATEST_RUN_ID=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].id')
          LATEST_RUN_URL=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].html_url')
          LATEST_RUN_COMMIT=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].head_sha' | cut -c1-7)

          # Exit gracefully if no successful run is found
          if [ -z "$LATEST_RUN_ID" ] || [ "$LATEST_RUN_ID" == "null" ]; then
            echo "No successful runs found for ${TARGET_REPO} or API error."
            echo "send_notification=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Read the ID of the last run we notified about from a temporary file
          if [ -f "last_run_id.txt" ]; then
            PREVIOUS_RUN_ID=$(cat last_run_id.txt)
          else
            PREVIOUS_RUN_ID="0"
          fi
          
          echo "Latest successful run ID: ${LATEST_RUN_ID}"
          echo "Previously notified run ID: ${PREVIOUS_RUN_ID}"

          # If the latest run ID is new, prepare to send a notification
          if [ "$LATEST_RUN_ID" != "$PREVIOUS_RUN_ID" ]; then
            echo "New artifact found! Preparing notification."
            echo "send_notification=true" >> $GITHUB_OUTPUT
            echo "new_run_url=${LATEST_RUN_URL}" >> $GITHUB_OUTPUT
            echo "new_run_commit=${LATEST_RUN_COMMIT}" >> $GITHUB_OUTPUT
            
            # Save the new ID to the file for the next check
            echo $LATEST_RUN_ID > last_run_id.txt
          else
            echo "No new artifacts since last check."
            echo "send_notification=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Notification
        # This step only runs if a new artifact was found
        if: steps.get_run.outputs.send_notification == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸ”” *New LSPosed Artifact Detected!*
            
            A new successful build was found in **JingMatrix/LSPosed**.

            *Commit*: `${{ steps.get_run.outputs.new_run_commit }}`
            
            You can download the artifact from the workflow run page:
            ${{ steps.get_run.outputs.new_run_url }}

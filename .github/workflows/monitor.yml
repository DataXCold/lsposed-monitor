# .github/workflows/monitor_lsposed.yml

name: Monitor LSPosed Artifacts

on:
  schedule:
    # Runs every 15 minutes to check for new artifacts
    - cron: "*/15 * * * *"
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  check-for-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest successful workflow run in JingMatrix/LSPosed
        id: get_run
        run: |
          TARGET_REPO="JingMatrix/LSPosed"
          API_URL="https://api.github.com/repos/${TARGET_REPO}/actions/runs?status=success&per_page=1"
          
          LATEST_RUN_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" $API_URL)
          
          # Get the latest run's details from the API
          LATEST_RUN_ID=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].id')
          LATEST_RUN_URL=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].html_url')
          # --- NEW: Get the full commit ID (SHA) ---
          LATEST_COMMIT_ID=$(echo $LATEST_RUN_INFO | jq -r '.workflow_runs[0].head_sha')

          if [ -z "$LATEST_RUN_ID" ] || [ "$LATEST_RUN_ID" == "null" ]; then
            echo "No successful runs found for ${TARGET_REPO} or API error."
            echo "send_notification=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Read the previously stored run ID and commit ID
          PREVIOUS_RUN_ID=$(cat last_run_id.txt 2>/dev/null || echo "0")
          # --- NEW: Read the previously stored commit ID ---
          PREVIOUS_COMMIT_ID=$(cat last_commit_id.txt 2>/dev/null || echo "none")
          
          echo "Latest successful run ID: ${LATEST_RUN_ID}"
          echo "Previously notified run ID: ${PREVIOUS_RUN_ID}"
          echo "Latest commit ID: ${LATEST_COMMIT_ID}"
          echo "Previously notified commit ID: ${PREVIOUS_COMMIT_ID}"

          # --- MODIFIED: Failsafe condition checks both run ID and commit ID ---
          if [ "$LATEST_RUN_ID" != "$PREVIOUS_RUN_ID" ] && [ "$LATEST_COMMIT_ID" != "$PREVIOUS_COMMIT_ID" ]; then
            echo "New artifact and new commit found! Preparing notification."
            echo "send_notification=true" >> $GITHUB_OUTPUT
            echo "new_run_url=${LATEST_RUN_URL}" >> $GITHUB_OUTPUT
            # Pass a shortened commit ID for a cleaner message
            echo "new_run_commit=$(echo $LATEST_COMMIT_ID | cut -c1-7)" >> $GITHUB_OUTPUT
            
            # --- MODIFIED: Save both new IDs for the next check ---
            echo $LATEST_RUN_ID > last_run_id.txt
            echo $LATEST_COMMIT_ID > last_commit_id.txt
          else
            echo "No new commit since last check. No notification will be sent."
            echo "send_notification=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Notification
        if: steps.get_run.outputs.send_notification == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸ”” *New LSPosed Artifact Detected!*
            
            A new successful build was found in **JingMatrix/LSPosed**.

            *Commit*: `${{ steps.get_run.outputs.new_run_commit }}`
            
            You can download the artifact from the workflow run page:
            ${{ steps.get_run.outputs.new_run_url }}
